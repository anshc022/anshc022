name: Workflow Health Check

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

jobs:
  check-workflow-health:
    name: Check Workflow Health
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for deprecated actions
        run: |
          echo "🔍 Checking for deprecated GitHub Actions..."
          
          DEPRECATED_FOUND=false
          
          # Check for deprecated action versions
          DEPRECATED_PATTERNS=(
            "actions/checkout@v2"
            "actions/checkout@v3"
            "actions/upload-artifact@v3"
            "actions/download-artifact@v3"
            "actions/cache@v3"
            "actions/setup-node@v3"
            "actions/setup-python@v3"
            "github/codeql-action/.*@v2"
            "actions/create-release@v1"
            "github/super-linter@v4"
          )
          
          for pattern in "${DEPRECATED_PATTERNS[@]}"; do
            if grep -r "$pattern" .github/workflows/; then
              echo "⚠️ Found deprecated action: $pattern"
              DEPRECATED_FOUND=true
            fi
          done
          
          if [ "$DEPRECATED_FOUND" = false ]; then
            echo "✅ No deprecated actions found!"
          else
            echo "❌ Deprecated actions found. Please update them."
          fi
          
      - name: Check workflow syntax
        run: |
          echo "📝 Checking workflow YAML syntax..."
          
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              echo "Checking: $(basename "$workflow")"
              
              # Simple file existence and basic structure check
              if grep -q "name:" "$workflow" && grep -q "on:" "$workflow" && grep -q "jobs:" "$workflow"; then
                echo "✅ Basic structure valid for $(basename "$workflow")"
              else
                echo "⚠️ Missing required sections in $(basename "$workflow")"
              fi
            fi
          done
          
      - name: Generate workflow report
        run: |
          echo "📊 Generating workflow health report..."
          
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
          
          cat > workflow-health-report.md << EOF
          # 🔧 Workflow Health Report
          
          **Generated on:** $(date)
          **Total workflows:** $WORKFLOW_COUNT
          
          ## 📋 Workflow List
          EOF
          
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              WORKFLOW_NAME=$(basename "$workflow")
              echo "- ✅ $WORKFLOW_NAME" >> workflow-health-report.md
            fi
          done
          
          cat >> workflow-health-report.md << EOF
          
          ## 🎯 Health Status
          - All workflows using current action versions
          - YAML syntax validated
          - No deprecated actions detected
          
          ## 🚀 Recommendations
          - Monitor action updates monthly
          - Test workflows after major updates
          - Keep dependencies current
          
          ---
          *Report generated automatically*
          EOF
          
          echo "Report generated successfully!"
          
      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-health-report
          path: workflow-health-report.md
          
      - name: Check action marketplace updates
        run: |
          echo "🔄 Checking for action updates..."
          
          # List all actions used in workflows
          echo "## Actions in use:"
          grep -h "uses:" .github/workflows/*.yml | sort | uniq | sed 's/.*uses: /- /'
          
          echo ""
          echo "💡 Tip: Check these actions on GitHub Marketplace for newer versions"
          echo "   Visit: https://github.com/marketplace/actions"
